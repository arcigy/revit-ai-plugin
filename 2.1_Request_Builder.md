# 2.1 Request Builder

## ğŸ¯ Purpose
The Request Builder is responsible for **constructing structured payloads** that will be sent from the backend to the AI model.  
It standardizes all inputs from the frontend (command text, Revit selection, image context, active view) into **consistent JSON**, ensuring that AI receives **full context** to generate deterministic workflows.

---

## ğŸ§± Component Structure

| Component | Description | Type |
|-----------|------------|------|
| `request_builder.py` | Main class responsible for building AI request payloads | Python Class |
| `models.py` | Pydantic models for structured input/output | Python |
| `image_utils.py` | Handles resizing, encoding, and validating uploaded images | Python |
| `validation.py` | Ensures required fields exist, raises errors for missing or invalid input | Python |

---

## ğŸ§­ Workflow Overview

[Frontend Command + Selection + Image]
â”‚
â–¼
[RequestBuilder.validate_input()]
â”‚
â–¼
[RequestBuilder.build_payload()]
â”‚
â–¼
[Structured JSON ready for AI Orchestrator]


---

## ğŸ§© Functionality

### 1. Input Validation

- Ensures required fields are present:
  - `command_text` (string, non-empty)
  - `context` (active view, selection)
  - `image_context` (optional, valid Base64-encoded image)
- Validates selection elements:
  - Each element has `id`, `category`, and `name`.
- Validates image:
  - Base64 format
  - Maximum size (512px per side recommended)
- Raises exceptions for invalid input.

**Python Example:**
```python
from pydantic import BaseModel, ValidationError
from typing import List, Optional

class SelectedElement(BaseModel):
    id: int
    name: str
    category: str

class ImageContext(BaseModel):
    filename: str
    base64: str

class CommandRequest(BaseModel):
    command_text: str
    active_view: str
    selected_elements: List[SelectedElement]
    image_context: Optional[ImageContext] = None
2. Payload Construction
Combines all inputs into a single structured object.

Adds metadata for AI:

Timestamp

Unique request ID

Frontend source info (plugin version, user ID if needed)

Converts object to JSON for sending to LLM client.

Python Example:


import json
from datetime import datetime
import uuid

class RequestBuilder:
    @staticmethod
    def build_payload(command_text: str, active_view: str,
                      selected_elements: List[SelectedElement],
                      image_context: ImageContext = None) -> str:
        request_id = str(uuid.uuid4())
        payload = {
            "request_id": request_id,
            "timestamp": datetime.utcnow().isoformat(),
            "command_text": command_text,
            "context": {
                "active_view": active_view,
                "selected_elements": [e.dict() for e in selected_elements]
            },
            "image_context": image_context.dict() if image_context else None
        }
        return json.dumps(payload)
3. Multimodal Support
Handles text commands, Revit selection, and optional images.

Encodes images as Base64 for safe transport.

Validates image size and format before including in payload.

Python Example:


from PIL import Image
import base64
import io

def encode_image(image_path: str, max_size: int = 512) -> str:
    img = Image.open(image_path)
    img.thumbnail((max_size, max_size))
    buffered = io.BytesIO()
    img.save(buffered, format="PNG")
    return base64.b64encode(buffered.getvalue()).decode()
4. Error Handling
Invalid commands or missing selections raise ValueError.

Images that fail encoding raise IOError.

Payload builder should never produce incomplete JSON.

Python Example:

def validate_command(command_text: str, selected_elements: List[SelectedElement]):
    if not command_text.strip():
        raise ValueError("Command text cannot be empty.")
    if not selected_elements:
        raise ValueError("At least one element must be selected.")
âš ï¸ Key Considerations
Consistency: Always produce same JSON structure for same input.

Security: Validate and sanitize inputs to prevent injection attacks in AI prompts.

Scalability: Should handle large selections without performance degradation.

Extensibility: Easy to add new input types (e.g., annotations, external references).

Debugging: Include request_id and timestamp for traceability in logs and memory storage.

ğŸ“¦ Suggested File Structure

/Backend
  â”œâ”€â”€ request_builder.py
  â”œâ”€â”€ image_utils.py
  â”œâ”€â”€ validation.py
  â””â”€â”€ models.py
âœ… Objective
After implementing the Request Builder:

Backend receives consistent, validated JSON for AI.

Supports text, selection, and image input.

Payloads include metadata for debugging and AI memory.

Safe, modular, and ready to integrate with AI Orchestrator and LLM client